# 测试文档

## 概述

本项目使用 **Vitest** 作为测试框架，配置了 **dotenv** 来加载环境变量。

## 测试结构

```
src/test/
├── setup.ts                    # 测试环境设置
├── parsers/
│   └── xiaohongshu.test.ts     # 小红书解析器测试
└── README.md                   # 本文档
```

## 运行测试

### 单个解析器测试
```bash
# 运行小红书解析器测试
npm run test:xiaohongshu

# 运行所有单元测试
npm run test:unit

# 运行测试并打开UI界面
npm run test:ui
```

### 环境变量

测试会自动加载 `.env.local` 文件中的环境变量：

```bash
LLM_API_KEY="your-api-key"
LLM_API_BASE_URL="your-api-base-url" 
LLM_MODEL="your-model-name"
ENABLE_AI=true
```

## 小红书解析器测试

### 测试覆盖范围

1. **基础功能测试**
   - ✅ 平台识别 
   - ✅ URL验证

2. **内容解析测试**
   - ✅ 集成测试（真实URL解析）
   - ✅ 失败情况处理

3. **Mock测试**
   - ✅ 超时配置
   - ✅ 域名验证
   - ✅ 平台类型

4. **错误处理测试**
   - ✅ 无效URL处理
   - ✅ 错误处理机制

### 测试URL

- **真实测试链接**: `http://xhslink.com/n/9qQs6fCAtZN`
- **用途**: 验证解析器能够正确处理真实的小红书分享链接

### 测试特点

- **混合测试策略**: 结合集成测试和单元测试
- **错误容忍**: 集成测试失败时会优雅降级，验证错误处理
- **环境检查**: 自动检查必要的环境变量
- **超时控制**: 合理的超时设置避免测试挂起

### 已知问题

- **Playwright稳定性**: 在某些环境下，Playwright可能出现浏览器上下文关闭的问题
- **网络依赖**: 集成测试依赖网络连接和目标网站的可用性
- **解决方案**: 测试设计具有容错性，即使集成测试失败也会验证错误处理逻辑

## 扩展测试

### 添加新解析器测试

1. 在 `src/test/parsers/` 创建新的测试文件
2. 遵循现有的测试模式
3. 在 `package.json` 添加对应的npm script

### 测试最佳实践

1. **平衡集成测试和单元测试**: 集成测试验证真实场景，单元测试确保稳定性
2. **优雅的错误处理**: 网络相关测试应该能够容忍失败
3. **环境变量检查**: 测试开始时验证必要的环境配置
4. **合理的超时**: 设置适当的测试超时时间

## 配置文件

### vitest.config.ts
- 设置Node环境
- 配置路径别名
- 设置全局测试超时
- 指定setup文件

### src/test/setup.ts  
- 加载dotenv环境变量
- 设置全局测试配置
- 清理mock状态